{% extends '__basePrestamos.html' %}
{% block content %}

<table id="detalleTabla" class="table table-striped table-bordered table-responsive dataTable_width_auto display" style="width:100%">
    <thead>
        <tr>
            <th>Info</th>
            <th>Folio Préstamo</th>
            <th>Usuario</th>
            <th>Fecha Vencimiento.</th>
        </tr>
    </thead>
    <tbody>
        {% for data in prestamos %}
        <tr>
            <td></td>
            <td>{{ data.pres_folio }}</td>
            <td>{{ data.usua_clave }}</td>
            <td>
                {% if data.pres_fechahora < hace_siete_dias %}
                <div class="alert alert-warning">{{ data.pres_fechahora }}</div>
                {% elif data.pres_fechahora > hace_siete_dias and data.pres_fechahora < fecha_actual %}
                <div class="alert alert-info">{{ data.pres_fechahora }}</div>
                {% else %}
                {{ data.pres_fechahora }}
                {% endif %}
            </td>
        </tr>
        {% empty %}
        {% endfor %}
    </tbody>
</table>

<!-- Modal Listar Cintas -->
<div class="modal fade" id="modalCintas">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title mb-3">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span>Usuario Préstamo</span>
                        <i class='fas fa-handshake'></i>
                    </div>
                </h4>
                <input type="text" id="inputDetalles" disabled>
                <input type="text" id="fechaActual"  style="width: 290px;" disabled>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: 500px;">
                <form>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label">Nombre</label>
                        <div class="col-md-7 mb-1">
                            <input type="text" disabled autocomplete="off" class="form-control" id="nombre">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-2 col-form-label">Email</label>
                        <div class="col-md-7 mb-1">
                            <input type="email" disabled autocomplete="off" class="form-control" id="email">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-2 col-form-label">Matricula</label>
                        <div class="col-md-3 mb-1">
                            <input type="text" disabled autocomplete="off" class="form-control" id="matricula">
                        </div>
                        <label class="col-md-1 col-form-label text-md-end">Ext.</label>
                        <div class="col-md-3 mb-1">
                            <input type="text" disabled autocomplete="off" class="form-control" id="extension">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-2 col-form-label">Puesto</label>
                        <div class="col-md-7 mb-1">
                            <input type="text" disabled autocomplete="off" class="form-control form-control-sm" id="puesto">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-2 col-form-label">Fecha Prestamo</label>
                        <div class="col-md-7 mb-1">
                            <input type="text" disabled autocomplete="off" class="form-control form-control-sm" id="fechaPrestamo">
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-md-3 col-form-label"></label>
                        <div class="col-md-3 mb-3">
                            <input type="text" class="form-control" id="estadoPrestamo" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="closeModal"><i class="fa fa-reply-all"></i> Salir </button>
            </div>
        </div>
    </div>
</div>

<br>
<br>

<script>
$(document).ready(function() {
    $('#detalleTabla').DataTable({
        ...columns,
        autoFill: {
            columns: [3]
        },
        columns: [{
                "data": "pres_folio",
                "render": function(data, type, row, meta) {
                    return "<a class='ver-detalle' data-folio='" + data + "' data-toggle='modal' data-target='#modalCintas'><i class='fa-sharp fa-solid fa-info-circle' style='color:#9D2449'></i></a>";
                }
            },
            {
                "data": "pres_folio"
            },
            {
                "data": "usua_clave"
            },
            {
                "data": "pres_fechahora"
            },
        ],
        createdRow: function(row, data, dataIndex) {
            $(row).data('folio', data.pres_folio);
        }
    });

    $(document).on('click', '.ver-detalle', function() {
        let folio = $(this).data('folio');
        $('#inputDetalles').val(`No. de Folio: ${folio}`);

        $.ajax({
            url: '{% url "obtenerPeoplePerson" %}',
            data: {
                q: folio
            },
            dataType: 'json',
            success: function(data) {
                // Actualizar los valores de matrícula y puesto en los campos de entrada
                $('#matricula').val(data.Matricula);
                $('#puesto').val(data.Puesto);
                $('#nombre').val(data.Obtiene);
                $('#extension').val(data.Extension);
                $('#email').val(data.Email);
                $('#fechaPrestamo').val(data.PrestamoFecha);
                $('#fechaActual').val(`Fecha Actual: ${data.fechaActual}`);

                let actual = new Date(data.fechaActual).getTime();
                let tiempoDevolucion = new Date(data.tiempoDevolucion).getTime();
                let fechaPrestamo = new Date(data.PrestamoFecha).getTime();

                if (fechaPrestamo > tiempoDevolucion) {
                    $('#estadoPrestamo').val('Vigente');
                    $('#estadoPrestamo').addClass('alert alert-success center-text ');                     
                }else {
                    $('#estadoPrestamo').val('Vencido');
                    $('#estadoPrestamo').addClass('alert alert-danger center-text');
                }
            },
            error: function(xhr, status, error) {
                console.error(error);
            }
        });
    });
});
    
</script>

<style>
.detalle ul {
    display: none;
}
</style>
{% endblock %}