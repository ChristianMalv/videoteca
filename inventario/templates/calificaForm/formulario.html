{% extends 'templateBase.html' %}

{% block titulo %} Calificación {% endblock %}

{% block Contenido %}

<div class="card-body">
    {% comment %} <h1>Formulario</h1> {% endcomment %}
    <div class="col-md-12">
        <div class="card">
            <div class="card-body" style="background:#13322B">
                <div class="d-flex justify-content-center">
                  <li>
                    <a style="color:#ffffff; "class="btn-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDatosGenerales" aria-expanded="false" aria-controls="collapseDatosGenerales">
                      <div style="display: flex; flex-direction: column; align-items: center;">
                        <span> Datos Generales </span>
                        <i class='fas fa-database'></i>
                      </div>
                    </a>
                  </li>

                  <!-- Repite este patrón para otros botones -->
                  <li>
                    <a class="btn-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDescripcion" aria-expanded="false" aria-controls="collapseDescripcion">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <span> Descripción </span>
                            <i class="fa fa-audio-description"></i>
                        </div>
                    </a>
                  </li>

                  <!-- Repite este patrón para otros botones -->
                  <li>
                    <a class="btn-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMapa" aria-expanded="false" aria-controls="collapseMapa">
                      <div style="display: flex; flex-direction: column; align-items: center;">
                          <span> Mapa </span>
                          <i class='fas fa-map'></i>
                      </div>
                    </a>
                  </li>
                  
                  <!-- Repite este patrón para otros botones -->
                  <li>
                    <a class="btn-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTecnicas" aria-expanded="false" aria-controls="collapseTecnicas">
                      <div style="display: flex; flex-direction: column; align-items: center;">
                        <span> Técnicas </span>
                        <i class="fa-solid fa-language"></i>
                      </div>
                    </a>
                  </li>

                <li>
                  <a class="btn-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRealizacion" aria-expanded="false" aria-controls="collapseRealizacion">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span> Realización </span>
                        <i class='fas fa-clipboard-list'></i>
                    </div>
                  </a>
                </li>
              </div>
            </div>

            <div class="collapse" id="collapseDatosGenerales">
                <div class="card card-body ">
                    <h2> Datos Generales </h2>
                    <form enctype="multipart/form-data" method="post">
                        {% csrf_token %}
                        <div class="row mt-2">
                          {% for field in formulario_principal %}
                          <div class="col-md-4 mb-2">
                            <div class="mb-1">
                              {% if field.name == 'axo_produccion' %}
                                <label for="{{ field.id_for_label }}" class="form-label">Año de producción</label>
                                <input type="text" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="Año de producción">
                                {{ field.errors }}
                              {% elif field.name == 'codigo_barras' %}
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                <input type="text" id="codigo_barras" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="{{ field.label }}">
                                {{ field.errors }}
                              {% else %}
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {% if field.name == 'fecha_calificacion' %}
                                  <input type="date" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="{{ field.label }}">
                                  {{ field.errors }}
                                {% elif field.name == 'observaciones' %}
                                  <textarea name="{{ field.name }}" class="form-control smaller-input" placeholder="{{ field.label }}" rows="3">{{ field.value|default_if_none:'' }}</textarea>
                                  {{ field.errors }}
                                {% else %}
                                  {% if field.field.widget.input_type == 'select' %}
                                    <select name="{{ field.name }}" class="form-control smaller-input">
                                      {% for choice in field.field.choices %}
                                        {% if field.value|stringformat:'s' == choice.0|stringformat:'s' %}
                                          <option value="{{ choice.0 }}" selected>{{ choice.1 }}</option>
                                          {{ field.errors }}
                      
                                        {% else %}
                                          <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                          {{ field.errors }}
                                          {% endif %}
                                        {% endfor %}
                                    </select>
                                  {% else %}
                                    {% if field.name != 'axo_produccion' and field.field.widget.input_type != 'hidden' %}
                                      <input type="{{ field.field.widget.input_type }}" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="{{ field.label }}">
                                      {{ field.errors }}
                                    {% endif %}
                                  {% endif %}
                                {% endif %}
                              {% endif %}
                            </div>
                          </div>
                        {% endfor %}
                        </div>
                        <div class="d-flex justify-content-center">
                          <div>
                            <button type="button" id="agregaPrograma" class="btn btn-editar btn-sm active text-white mt-3" style="background-color:#9D2449;"  data-bs-toggle="modal" data-bs-target="#modalIngresa"> 
                              <i class="fa-solid fa-circle-plus" style="color:white;"></i>
                                <span style="color: white;">Añadir Programa</span>
                            </button>
                          
                          </div>
                        </div>
                      </form>
                </div>
            </div>
 
            <!-- Repite este patrón para otras secciones de formulario -->
            <div class="collapse" id="collapseDescripcion">
              <div class="card card-body">
                  <h2> Descripción </h2>
                  <form enctype="multipart/form-data" method="post">
                      {% csrf_token %}
                      <div class="row mt-2">
                          {% for campo in formulario_descripcion  %}
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="" class="form-label">{{ campo.label }}</label>
                                  <input
                                      type="{{ campo.field.widget.input_type }}"
                                      class="form-control"
                                      name="{{ campo.name }}"
                                      id=""
                                      aria-describedby="helpId"
                                      placeholder="{{ campo.label }}"
                                  />
                              </div>
                          </div>
                          {% endfor %}
                      </div>
                  </form>
              </div>
            </div>
          
            <!-- Repite este patrón para otras secciones de formulario -->
            <div class="collapse" id="collapseMapa">
              <div class="card card-body">
                  <h2> Mapa </h2>
                  <form enctype="multipart/form-data" method="post">
                      {% csrf_token %}
                      <div class="row mt-2">
                          {% for campo in formulario_mapa  %}
                          <div class="col-md-6">
                              <div class="mb-3">
                                  <label for="" class="form-label">{{ campo.label }}</label>
                                  <input
                                      type="{{ campo.field.widget.input_type }}"
                                      class="form-control"
                                      name="{{ campo.name }}"
                                      id=""
                                      aria-describedby="helpId"
                                      placeholder="{{ campo.label }}"
                                  />
                              </div>
                          </div>
                          {% endfor %}
                      </div>
                  </form>
              </div>
            </div>
          
          <!-- Repite este patrón para otras secciones de formulario -->
          <div class="collapse" id="collapseTecnicas">
            <div class="card card-body">
                <h2> Técnicas </h2>
                <form enctype="multipart/form-data" method="post">
                    {% csrf_token %}
                    <div class="row mt-2">
                        {% for campo in formulario_tecnicas  %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="" class="form-label">{{ campo.label }}</label>
                                <input
                                    type="{{ campo.field.widget.input_type }}"
                                    class="form-control"
                                    name="{{ campo.name }}"
                                    id=""
                                    aria-describedby="helpId"
                                    placeholder="{{ campo.label }}"
                                />
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </form>
            </div>
          </div>

          <!-- Repite este patrón para otras secciones de formulario -->
          <div class="collapse" id="collapseRealizacion">
            <div class="card card-body">
                <h2> Realización </h2>
                <form enctype="multipart/form-data" method="post">
                    {% csrf_token %}
                    <div class="row mt-2">
                        {% for campo in formulario_realizacion  %}
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="" class="form-label">{{ campo.label }}</label>
                                <input
                                    type="{{ campo.field.widget.input_type }}"
                                    class="form-control"
                                    name="{{ campo.name }}"
                                    id=""
                                    aria-describedby="helpId"
                                    placeholder="{{ campo.label }}"
                                />
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="d-flex justify-content-center">
                      <button name="" id="revicionForm" class="btn btn-revicion btn-sm active mt-3" style="background-color:#18463b" href="#" role="button">  
                        <div style="display: flex; flex-direction: column; align-items: center;">
                          <span style="color: white;">Guardar para revisión</span>
                          <i class="fas fa-save mt-1" style="color: white;"></i>
                        </div> 
                      </button> 
                    </div>
                </form>
            </div>
          </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalIngresa" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color:#18463b;">
        <h5 class="modal-title" id="exampleModalLabel" style="color: white;">Añadir Programa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" style="background-color:#9D2449;"  aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formularioPrograma">
          {% csrf_token %}
          {% for field in modal_form %}
            {% if field.name == 'programa' or field.name == 'serie' or field.name == 'subtitulo_programa' or field.name == 'subtitserie' %}
              <div class="mb-3">
                <!-- Asignamos un id al campo -->
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                <input type="{{ field.field.widget.input_type }}" id="{{ field.name }}" name="{{ field.name }}" class="form-control" placeholder="{{ field.label }}">
              </div>
            {% endif %}
          {% endfor %}
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" style="background-color:#9D2449" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-agregar" style="background-color:#b38e5d" id="agregarProgramaSerie" >
          <span style="color: white;">Agregar</span>
        </button>
        {% comment %} <button type="button" class="btn btn-guardar-modal" style="background-color:#18463b" id="guardarModal">
          <span style="color: white;">Guardar en sesión</span>
        </button> {% endcomment %}
      </div>
    </div>
  </div>
</div>

<div class="card-body">
  <div class="table-responsive"> <!-- Agregar esta clase -->
    <table class="table table-hover" id="tablePrograma">
      <!-- ... Código de la tabla ... -->
      <thead>
        <tr>
          <th>Id</th>
          <th>Código de barras</th>
          <th>Serie</th>
          <th>Programa</th>
          <th>Subtitulo Programa</th>
          <th>Subtitulo Serie</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
       <!--lA TABLA SE LLENA DINAMICAMENTE EN EL JAVASCRIPT-->
      </tbody>
    </table>
  </div> 
</div> 

<script>
  $("#tablePrograma").hide();

  document.getElementById('agregarProgramaSerie').addEventListener('click', function() {
    const programa = document.getElementById('programa').value;
    const serie = document.getElementById('serie').value;
    const programaSubtitulo = document.getElementById('subtitulo_programa').value;
    const serieSubtitulo = document.getElementById('subtitserie').value;
    const codigoBarrasValor = document.getElementById('codigo_barras').value;
  
    // Validación para asegurarse de que los campos no estén vacíos
    if (programa.trim() === '' || serie.trim() === '' || serieSubtitulo.trim() === '' || programaSubtitulo.trim() === '') {
      messageAlerta('info', 'Completa los campos solicitados para agregar un programa.', '¡Oops!', '#18463b');
      return;
    } else if (codigoBarrasValor.trim() === '') {
      messageAlerta('info', 'No ingresaste un Código de Barras.', '¡Oops!', '#18463b');
      return;
    }
  
    // Agregar los datos a la lista de programas y series
    programasYSeries.push({
      id: programasYSeries.length + 1, // Cambia esto según tu lógica
      programa: programa,
      serie: serie,
      programaSubtitulo: programaSubtitulo,
      serieSubtitulo: serieSubtitulo,
      codigoBarras: codigoBarrasValor,
    });
  
    $.ajax({
        url: '{% url "formulario" %}', // Cambia a la URL correcta en tu aplicación
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          programasYSeries: JSON.stringify(programasYSeries),
        },
        success: function(response) {
         
          // Agregar la nueva fila a la tabla
          const newRow = tableBody.insertRow();
          const cellId = newRow.insertCell(0);
          const cellCodigoBarras = newRow.insertCell(1);
          const cellSerie = newRow.insertCell(2);
          const cellPrograma = newRow.insertCell(3);
          const cellSub_Programa = newRow.insertCell(4);
          const cellSub_Serie = newRow.insertCell(5);
          const cellAcciones = newRow.insertCell(6);
  
          cellId.innerHTML = programasYSeries.length;
          cellCodigoBarras.innerHTML = codigoBarrasValor;
          cellSerie.innerHTML = serie;
          cellPrograma.innerHTML = programa;
          cellSub_Programa.innerHTML = programaSubtitulo;
          cellSub_Serie.innerHTML = serieSubtitulo;
          cellAcciones.innerHTML = `
            <button class="btn btn-añadir btn-sm text-white" style="background-color:#9D2449;" title="Eliminar" data-id="${newRow.id}" onclick="eliminarColumn(this)">
              <div style="display: flex; flex-direction: column; align-items: center;">
                <i class="fa-sharp fa-solid fa-trash"></i>
              </div>
            </button>`;
          
          // Limpiar el formulario y mostrar la tabla
          limpiarFormulario();
          tableBody.parentElement.style.display = 'table';
          
      
        },
        error: function(xhr, ajaxOptions, thrownError) {
          console.log('Error al guardar los datos:', xhr.status, thrownError);
        }
    });
  });

  $("#revicionForm").click(function(event) {
    event.preventDefault(); // Evitar el envío de formulario por defecto
  
    let $button = $(this); // Guardamos una referencia al botón actual
    Swal.fire({
      title: '¿Deseas enviar este formulario\n a revisión?',
      text: 'No podrás revertir esta acción.',
      icon: 'info',
      showCancelButton: true,
      confirmButtonColor: '#18463b',
      cancelButtonColor: '#9D2449',
      confirmButtonText: 'Sí, continuar'
    }).then((result) => {
      if (result.isConfirmed) {
        // Obtener los datos del formulario
        let formData = $('form').serialize();
        
        // Realizar la petición AJAX para guardar los datos
        $.ajax({
          url: '{% url "tecnicas" %}',
          type: 'POST',
          data: formData,
          success: function(response) {
            Swal.fire(
              'Registrado',
              'Su formulario ha sido registrado y se encuentra en calificación.',
              'success'
            )
            atrasBtn.style.display = 'none';  // Oculta el botón de "Atrás"
            $button.hide(); // Oculta el botón utilizando la referencia guardada
          },
          error: function(xhr, ajaxOptions, thrownError) {
            // Manejar el error de la petición AJAX si es necesario
            console.log(xhr.status);
            console.log(thrownError);
          }
        });
      }
    });
  });

</script>

{% endblock %}
