<form enctype="multipart/form-data" method="post">
  {% csrf_token %}
  <div class="row">
    {% for field in formulario %}
    <div class="col-md-4 mb-3">
      <div class="mb-3">
        {% if field.name == 'axo_produccion' %}
          <label for="{{ field.id_for_label }}" class="form-label">Año de producción</label>
          <input type="text" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="Año de producción">
          {{ field.errors }}
        {% elif field.name == 'codigo_barras' %}
          <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
          <input type="text" id="codigo_barras" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="{{ field.label }}">
          {{ field.errors }}
        {% else %}
          <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
          {% if field.name == 'fecha_calificacion' %}
            <input type="date" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="{{ field.label }}">
            {{ field.errors }}
          {% elif field.name == 'observaciones' %}
            <textarea name="{{ field.name }}" class="form-control smaller-input" placeholder="{{ field.label }}" rows="3">{{ field.value|default_if_none:'' }}</textarea>
            {{ field.errors }}
          {% else %}
            {% if field.field.widget.input_type == 'select' %}
              <select name="{{ field.name }}" class="form-control smaller-input">
                {% for choice in field.field.choices %}
                  {% if field.value|stringformat:'s' == choice.0|stringformat:'s' %}
                    <option value="{{ choice.0 }}" selected>{{ choice.1 }}</option>
                    {{ field.errors }}

                  {% else %}
                    <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                    {{ field.errors }}
                    {% endif %}
                  {% endfor %}
              </select>
            {% else %}
              {% if field.name != 'axo_produccion' and field.field.widget.input_type != 'hidden' %}
                <input type="{{ field.field.widget.input_type }}" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" class="form-control smaller-input" placeholder="{{ field.label }}">
                {{ field.errors }}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% endfor %}
  </div>
  
  <div class="d-flex justify-content-center">
    <div>
      <button type="button" id="agregaPrograma" class="btn btn-editar btn-sm active text-white mt-3" style="background-color:#9D2449;"  data-bs-toggle="modal" data-bs-target="#modalIngresa"> 
        <i class="fa-solid fa-circle-plus" style="color:white;"></i>
          <span style="color: white;">Añadir Programa</span>
      </button>
    
      <a id="atrasBtn" type="submit" class="btn btn-atras btn-sm active text-white mt-3" style="background-color:#9D2449;" href="#" role="button"> 
        <i class="fas fa-hand-point-left mt-1" style="color: white;"></i>
          <span style="color: white;">Atrás</span>
      </a>
      
      <button type="submit" id="siguienteBtn" class="btn btn-siguiente btn-sm active text-white mt-3" style="background-color:#18463b;" role="button" > 
        <span style="color: white;">Siguiente</span>
        <i class="fas fa-hand-point-right mt-1" style="color: white;"></i>
      </button>
    
      <button name="" id="revicionForm" class="btn btn-revicion btn-sm active mt-3" style="background-color:#18463b" href="#" role="button">  
        <i class="fas fa-save mt-1" style="color: white;"></i> 
          <span style="color: white;">Guardar para revisión</span>
      </button> 
    </div>
  </div>
</form>

<div class="modal fade" id="modalIngresa" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color:#18463b;">
        <h5 class="modal-title" id="exampleModalLabel" style="color: white;">Añadir Programa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" style="background-color:#F9F4F4;"  aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formularioPrograma">
          {% csrf_token %}
          {% for field in formulario %}
            {% if field.name == 'programa' or field.name == 'serie' or field.name == 'subtitulo_programa' or field.name == 'subtitserie' %}
              <div class="mb-3">
                <!-- Asignamos un id al campo -->
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                <input type="{{ field.field.widget.input_type }}" id="{{ field.name }}" name="{{ field.name }}" class="form-control" placeholder="{{ field.label }}">
              </div>
            {% endif %}
          {% endfor %}
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" style="background-color:#9D2449" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-agregar" style="background-color:#b38e5d" id="agregarProgramaSerie" >
          <span style="color: white;">Agregar</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="card-body">
  <div class="table-responsive"> <!-- Agregar esta clase -->
    <table class="table table-hover" id="tablePrograma">
      <!-- ... Código de la tabla ... -->
      <thead>
        <tr>
          <th>Id</th>
          <th>Código de barras</th>
          <th>Serie</th>
          <th>Programa</th>
          <th>Subtitulo Programa</th>
          <th>Subtitulo Serie</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
       <!--lA TABLA SE LLENA DINAMICAMENTE EN EL JAVASCRIPT-->
      </tbody>
    </table>
  </div> 
</div> 

<script>
 // Lógica de navegación entre pestañas utilizando JavaScript

 document.getElementById('agregarProgramaSerie').addEventListener('click', function() {
  const programa = document.getElementById('programa').value;
  const serie = document.getElementById('serie').value;
  const programaSubtitulo = document.getElementById('subtitulo_programa').value;
  const serieSubtitulo = document.getElementById('subtitserie').value;
  const codigoBarrasValor = document.getElementById('codigo_barras').value;

  // Validación para asegurarse de que los campos no estén vacíos
  if (programa.trim() === '' || serie.trim() === '' || serieSubtitulo.trim() === '' || programaSubtitulo.trim() === '') {
    messageAlerta('info', 'Completa los campos solicitados para agregar un programa.', '¡Oops!', '#18463b');
    $("#tablePrograma").hide();
    return;
  } else if (codigoBarrasValor.trim() === '') {
    messageAlerta('info', 'No ingresaste un Código de Barras.', '¡Oops!', '#18463b');
    $("#tablePrograma").hide();
    return;
  }
    
  let programasYSeries = [];
  if (sessionStorage.getItem('programasYSeries')) {
    programasYSeries = JSON.parse(sessionStorage.getItem('programasYSeries'));
  }

    // Agregar los datos a la lista de programas y series
  programasYSeries.push({
    programa: programa,
    serie: serie,
    programaSubtitulo: programaSubtitulo,
    serieSubtitulo: serieSubtitulo,
  });

  localStorage.setItem('programasYSeries', JSON.stringify(programasYSeries));
  
  // Insertar datos en la tabla
  let tableBody = document.getElementById('tablePrograma').getElementsByTagName('tbody')[0];
  let newRow = tableBody.insertRow();
  // Asignar un ID único a la fila
  newRow.id = "fila-" + programasYSeries.length;
  let cellId = newRow.insertCell(0);
  let cellCodigoBarras = newRow.insertCell(1);
  let cellSerie = newRow.insertCell(2);
  let cellPrograma = newRow.insertCell(3);
  let cellSub_Programa = newRow.insertCell(4);
  let cellSub_Serie = newRow.insertCell(5);
  let cellAcciones = newRow.insertCell(6);

  // Llenar las celdas con los datos del programa y serie ingresados
  cellId.innerHTML = programasYSeries.length;
  cellCodigoBarras.innerHTML = codigoBarrasValor; // Esto lo obtendrías de algún campo del formulario
  cellSerie.innerHTML = serie;
  cellPrograma.innerHTML = programa;
  cellSub_Programa.innerHTML = programaSubtitulo;
  cellSub_Serie.innerHTML = serieSubtitulo;
  cellAcciones.innerHTML = `
    <button class="btn btn-añadir btn-sm text-white" style="background-color:#9D2449;" title="Eliminar" data-id="${newRow.id}" onclick="eliminarColumn(this)">
      <div style="display: flex; flex-direction: column; align-items: center;">
        <i class="fa-sharp fa-solid fa-trash"></i>
      </div>
    </button>`;


    limpiarFormulario()
  // Opcionalmente, puedes mostrar la tabla después de agregar los datos
  $("#tablePrograma").show();
});

const eliminarColumn = (button) => {
  // Obtener el id de la fila a eliminar desde el atributo data-id
  const rowId = button.getAttribute("data-id");
  
  // Buscar la fila a eliminar por su id
  const rowToDelete = document.getElementById(rowId);

  // Verificar si la fila existe antes de intentar eliminarla
  if (rowToDelete) {
    // Eliminar la fila de la tabla
    rowToDelete.remove();
  }
};

siguienteBtn.addEventListener('click', function() {
  // Redirige a la URL correspondiente a la siguiente vista
  if (window.location.href.includes('{% url "datosGenerales" %}')) {
    window.location.href = '{% url "descripcion" %}';
  } else if (window.location.href.includes('{% url "descripcion" %}')) {
    window.location.href = '{% url "mapa" %}';
  } else if (window.location.href.includes('{% url "mapa" %}')) {
    window.location.href = '{% url "realizacion" %}';
  } else if (window.location.href.includes('{% url "realizacion" %}')) {
    window.location.href = '{% url "tecnicas" %}';
  }
});

atrasBtn.addEventListener('click', function() {
  // Redirige a la URL correspondiente a la vista anterior
  if (window.location.href.includes('{% url "descripcion" %}')) {
    window.location.href = '{% url "datosGenerales" %}';
  } else if (window.location.href.includes('{% url "mapa" %}')) {
    window.location.href = '{% url "descripcion" %}';
  } else if (window.location.href.includes('{% url "realizacion" %}')) {
    window.location.href = '{% url "mapa" %}';
  } else if (window.location.href.includes('{% url "tecnicas" %}')) {
    window.location.href = '{% url "realizacion" %}';
  }
});

// Ocultar botones según la URL actual
if (window.location.href.includes('{% url "datosGenerales" %}')) {
  atrasBtn.style.display = 'none';  // Oculta el botón de "Atrás"
  revicionForm.style.display = 'none';  // Oculta el botón de "Guardar Formulario"   
} else if (window.location.href.includes('{% url "descripcion" %}')) {
  revicionForm.style.display = 'none';
  agregaPrograma.style.display = 'none';
  tablePrograma.style.display = 'none';
} else if (window.location.href.includes('{% url "mapa" %}')) {
  revicionForm.style.display = 'none';
  agregaPrograma.style.display = 'none';
  tablePrograma.style.display = 'none';

} else if (window.location.href.includes('{% url "realizacion" %}')) {
  revicionForm.style.display = 'none';
  agregaPrograma.style.display = 'none';
  tablePrograma.style.display = 'none';

} else if (window.location.href.includes('{% url "tecnicas" %}')) {
  siguienteBtn.style.display = 'none';
  agregaPrograma.style.display = 'none';
  tablePrograma.style.display = 'none';

}

$("#tablePrograma").hide();
   // Almacena los datos ingresados por el usuario en el modal
const programasYSeries = [];

const limpiarFormulario = () => {
  const formulario = document.getElementById('formularioPrograma');
  formulario.reset();
}

$("#revicionForm").click(function(event) {
  event.preventDefault(); // Evitar el envío de formulario por defecto

  let $button = $(this); // Guardamos una referencia al botón actual
  Swal.fire({
    title: '¿Deseas enviar este formulario\n a revisión?',
    text: 'No podrás revertir esta acción.',
    icon: 'info',
    showCancelButton: true,
    confirmButtonColor: '#18463b',
    cancelButtonColor: '#9D2449',
    confirmButtonText: 'Sí, continuar'
  }).then((result) => {
    if (result.isConfirmed) {
      // Obtener los datos del formulario
      let formData = $('form').serialize();
      
      // Realizar la petición AJAX para guardar los datos
      $.ajax({
        url: '{% url "tecnicas" %}',
        type: 'POST',
        data: formData,
        success: function(response) {
          Swal.fire(
            'Registrado',
            'Su formulario ha sido registrado y se encuentra en calificación.',
            'success'
          )
          atrasBtn.style.display = 'none';  // Oculta el botón de "Atrás"
          $button.hide(); // Oculta el botón utilizando la referencia guardada
        },
        error: function(xhr, ajaxOptions, thrownError) {
          // Manejar el error de la petición AJAX si es necesario
          console.log(xhr.status);
          console.log(thrownError);
        }
      });
    }
  });
});

</script>
